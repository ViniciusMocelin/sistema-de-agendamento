{% extends 'base.html' %}

{% block title %}Relatórios - Sistema de Agendamentos{% endblock %}

{% block extra_css %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
    .kpi-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        transition: transform 0.3s ease;
    }
    
    .kpi-card:hover {
        transform: translateY(-5px);
    }
    
    .kpi-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 0;
    }
    
    .kpi-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .kpi-change {
        font-size: 0.8rem;
        padding: 2px 8px;
        border-radius: 10px;
        background: rgba(255,255,255,0.2);
    }
    
    .chart-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .filter-card {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header dos Relatórios -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="text-primary mb-1">
                        <i class="fas fa-chart-bar me-2"></i>Relatórios e Analytics
                    </h2>
                    <p class="text-muted mb-0">
                        Insights detalhados do seu negócio
                        <small class="text-info">
                            <i class="fas fa-calendar me-1"></i>
                            {{ data_inicio|date:"d/m/Y" }} até {{ data_fim|date:"d/m/Y" }}
                        </small>
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#filtroModal">
                        <i class="fas fa-filter me-2"></i>Filtros
                    </button>
                    <a href="{% url 'agendamentos:dashboard' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- KPIs Financeiros -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card kpi-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-dollar-sign fa-2x mb-3"></i>
                    <h3 class="kpi-value">R$ {{ kpis_financeiros.faturamento_total|floatformat:2 }}</h3>
                    <p class="kpi-label mb-2">Faturamento Total</p>
                    <small class="kpi-change">
                        <i class="fas fa-calendar me-1"></i>{{ kpis_financeiros.dias_periodo }} dias
                    </small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card kpi-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-receipt fa-2x mb-3"></i>
                    <h3 class="kpi-value">R$ {{ kpis_financeiros.ticket_medio|floatformat:2 }}</h3>
                    <p class="kpi-label mb-2">Ticket Médio</p>
                    <small class="kpi-change">
                        <i class="fas fa-chart-line me-1"></i>Por atendimento
                    </small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card kpi-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle fa-2x mb-3"></i>
                    <h3 class="kpi-value">{{ kpis_financeiros.total_agendamentos }}</h3>
                    <p class="kpi-label mb-2">Atendimentos</p>
                    <small class="kpi-change">
                        <i class="fas fa-calendar-check me-1"></i>Concluídos
                    </small>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card kpi-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-trending-up fa-2x mb-3"></i>
                    <h3 class="kpi-value">
                        {% if kpis_financeiros.crescimento_mensal >= 0 %}
                            +{{ kpis_financeiros.crescimento_mensal }}%
                        {% else %}
                            {{ kpis_financeiros.crescimento_mensal }}%
                        {% endif %}
                    </h3>
                    <p class="kpi-label mb-2">Crescimento</p>
                    <small class="kpi-change">
                        <i class="fas fa-calendar-alt me-1"></i>Mensal
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos Principais -->
    <div class="row">
        <!-- Faturamento por Dia -->
        <div class="col-lg-8 mb-4">
            <div class="chart-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line text-success me-2"></i>
                        Faturamento Diário
                    </h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary active" onclick="toggleFaturamentoView('daily')">
                            Diário
                        </button>
                        <button class="btn btn-outline-primary" onclick="toggleFaturamentoView('cumulative')">
                            Acumulado
                        </button>
                    </div>
                </div>
                <div id="grafico-faturamento" style="height: 400px;"></div>
            </div>
        </div>

        <!-- Serviços Mais Realizados -->
        <div class="col-lg-4 mb-4">
            <div class="chart-container">
                <h5 class="mb-3">
                    <i class="fas fa-chart-pie text-warning me-2"></i>
                    Serviços Mais Realizados
                </h5>
                <div id="grafico-servicos" style="height: 400px;"></div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Clientes Mais Frequentes -->
        <div class="col-lg-6 mb-4">
            <div class="chart-container">
                <h5 class="mb-3">
                    <i class="fas fa-users text-info me-2"></i>
                    Top 10 Clientes Mais Frequentes
                </h5>
                <div id="grafico-clientes" style="height: 400px;"></div>
            </div>
        </div>

        <!-- Faturamento Mensal -->
        <div class="col-lg-6 mb-4">
            <div class="chart-container">
                <h5 class="mb-3">
                    <i class="fas fa-calendar-alt text-primary me-2"></i>
                    Faturamento por Mês
                </h5>
                <div id="grafico-mensal" style="height: 400px;"></div>
                
                <!-- Tabela de Resumo Mensal -->
                <div class="mt-3">
                    <h6>Resumo por Mês:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Mês</th>
                                    <th>Faturamento</th>
                                    <th>Crescimento</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in kpis_financeiros.faturamento_mensal %}
                                <tr>
                                    <td>{{ item.mes }}</td>
                                    <td>R$ {{ item.valor|floatformat:2 }}</td>
                                    <td>
                                        {% if forloop.counter > 1 %}
                                            {% with anterior=kpis_financeiros.faturamento_mensal|slice:":"|slice:"-2"|first %}
                                                {% if anterior.valor > 0 %}
                                                    {% widthratio item.valor anterior.valor 100 as crescimento %}
                                                    {% if crescimento >= 100 %}
                                                        <span class="text-success">
                                                            <i class="fas fa-arrow-up"></i> +{{ crescimento|add:"-100" }}%
                                                        </span>
                                                    {% else %}
                                                        <span class="text-danger">
                                                            <i class="fas fa-arrow-down"></i> -{{ 100|add:crescimento|add:"-100" }}%
                                                        </span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            {% endwith %}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Insights e Recomendações -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>Insights e Recomendações
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-star text-warning me-2"></i>Pontos Fortes</h6>
                            <ul class="list-unstyled">
                                {% if kpis_financeiros.crescimento_mensal > 0 %}
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    Crescimento mensal positivo de {{ kpis_financeiros.crescimento_mensal }}%
                                </li>
                                {% endif %}
                                {% if kpis_financeiros.ticket_medio > 50 %}
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    Ticket médio acima da média (R$ {{ kpis_financeiros.ticket_medio|floatformat:2 }})
                                </li>
                                {% endif %}
                                <li class="mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    {{ kpis_financeiros.total_agendamentos }} atendimentos realizados no período
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-target text-info me-2"></i>Oportunidades</h6>
                            <ul class="list-unstyled">
                                {% if kpis_financeiros.crescimento_mensal < 0 %}
                                <li class="mb-2">
                                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                    Foco na retenção de clientes para reverter queda
                                </li>
                                {% endif %}
                                {% if kpis_financeiros.ticket_medio < 50 %}
                                <li class="mb-2">
                                    <i class="fas fa-arrow-up text-primary me-2"></i>
                                    Oportunidade de aumentar ticket médio com serviços premium
                                </li>
                                {% endif %}
                                <li class="mb-2">
                                    <i class="fas fa-users text-info me-2"></i>
                                    Implementar programa de fidelidade para clientes frequentes
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-calendar-plus text-success me-2"></i>
                                    Promover serviços menos utilizados para diversificar receita
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Filtros -->
<div class="modal fade" id="filtroModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-filter me-2"></i>Filtrar Relatórios
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="get">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="data_inicio" class="form-label">Data Início</label>
                            <input type="date" class="form-control" id="data_inicio" name="data_inicio" 
                                   value="{{ data_inicio|date:'Y-m-d' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="data_fim" class="form-label">Data Fim</label>
                            <input type="date" class="form-control" id="data_fim" name="data_fim" 
                                   value="{{ data_fim|date:'Y-m-d' }}">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <h6>Períodos Rápidos:</h6>
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setPeriodo(7)">
                                    7 dias
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setPeriodo(30)">
                                    30 dias
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setPeriodo(90)">
                                    90 dias
                                </button>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="setPeriodo(365)">
                                    1 ano
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search me-2"></i>Aplicar Filtros
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Dados dos gráficos
    const servicosDados = {{ servicos_dados|safe }};
    const clientesCategorias = {{ clientes_dados.categorias|safe }};
    const clientesValores = {{ clientes_dados.valores|safe }};
    const faturamentoCategorias = {{ faturamento_dados.categorias|safe }};
    const faturamentoValores = {{ faturamento_dados.valores|safe }};
    const faturamentoMensal = {{ kpis_financeiros.faturamento_mensal|safe }};

    // Gráfico de Serviços (Pizza)
    const traceServicos = {
        labels: servicosDados.map(item => item.name),
        values: servicosDados.map(item => item.data),
        type: 'pie',
        hole: 0.4,
        marker: {
            colors: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe', '#43e97b', '#38f9d7', '#ffecd2', '#fcb69f']
        },
        textinfo: 'label+percent',
        textposition: 'outside'
    };

    const layoutServicos = {
        showlegend: false,
        margin: { t: 20, b: 20, l: 20, r: 20 },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { family: 'Arial, sans-serif', size: 12 }
    };

    Plotly.newPlot('grafico-servicos', [traceServicos], layoutServicos, {responsive: true, displayModeBar: false});

    // Gráfico de Clientes (Barras Horizontais)
    const traceClientes = {
        x: clientesValores,
        y: clientesCategorias,
        type: 'bar',
        orientation: 'h',
        marker: {
            color: 'rgba(102, 126, 234, 0.8)',
            line: {
                color: 'rgba(102, 126, 234, 1)',
                width: 1
            }
        }
    };

    const layoutClientes = {
        margin: { t: 20, b: 50, l: 150, r: 50 },
        xaxis: { title: 'Número de Atendimentos' },
        yaxis: { title: '' },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { family: 'Arial, sans-serif' }
    };

    Plotly.newPlot('grafico-clientes', [traceClientes], layoutClientes, {responsive: true, displayModeBar: false});

    // Gráfico de Faturamento Diário
    let faturamentoDaily = {
        x: faturamentoCategorias,
        y: faturamentoValores,
        type: 'scatter',
        mode: 'lines+markers',
        line: {
            color: '#28a745',
            width: 3
        },
        marker: {
            color: '#28a745',
            size: 6
        },
        fill: 'tonexty',
        fillcolor: 'rgba(40, 167, 69, 0.1)',
        name: 'Faturamento Diário'
    };

    // Calcular faturamento acumulado
    let acumulado = [];
    let soma = 0;
    faturamentoValores.forEach(valor => {
        soma += valor;
        acumulado.push(soma);
    });

    let faturamentoCumulative = {
        x: faturamentoCategorias,
        y: acumulado,
        type: 'scatter',
        mode: 'lines+markers',
        line: {
            color: '#007bff',
            width: 3
        },
        marker: {
            color: '#007bff',
            size: 6
        },
        fill: 'tonexty',
        fillcolor: 'rgba(0, 123, 255, 0.1)',
        name: 'Faturamento Acumulado',
        visible: false
    };

    const layoutFaturamento = {
        title: {
            text: 'Faturamento Diário',
            font: { size: 16 }
        },
        xaxis: {
            title: 'Data',
            tickangle: -45
        },
        yaxis: {
            title: 'Valor (R$)',
            tickformat: ',.2f'
        },
        margin: { t: 50, b: 100, l: 80, r: 50 },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { family: 'Arial, sans-serif' }
    };

    Plotly.newPlot('grafico-faturamento', [faturamentoDaily, faturamentoCumulative], layoutFaturamento, {responsive: true, displayModeBar: false});

    // Gráfico Mensal
    if (faturamentoMensal.length > 0) {
        const traceMensal = {
            x: faturamentoMensal.map(item => item.mes),
            y: faturamentoMensal.map(item => item.valor),
            type: 'bar',
            marker: {
                color: faturamentoMensal.map((item, index) => {
                    if (index === 0) return 'rgba(102, 126, 234, 0.8)';
                    const anterior = faturamentoMensal[index - 1].valor;
                    return item.valor >= anterior ? 'rgba(40, 167, 69, 0.8)' : 'rgba(220, 53, 69, 0.8)';
                }),
                line: {
                    color: 'rgba(102, 126, 234, 1)',
                    width: 1
                }
            }
        };

        const layoutMensal = {
            xaxis: { title: 'Mês' },
            yaxis: { 
                title: 'Faturamento (R$)',
                tickformat: ',.2f'
            },
            margin: { t: 20, b: 50, l: 80, r: 50 },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { family: 'Arial, sans-serif' }
        };

        Plotly.newPlot('grafico-mensal', [traceMensal], layoutMensal, {responsive: true, displayModeBar: false});
    }

    // Função para alternar visualização do faturamento
    window.toggleFaturamentoView = function(view) {
        const update = view === 'daily' ? 
            {'visible': [true, false]} : 
            {'visible': [false, true]};
        
        const newTitle = view === 'daily' ? 'Faturamento Diário' : 'Faturamento Acumulado';
        
        Plotly.restyle('grafico-faturamento', update);
        Plotly.relayout('grafico-faturamento', {'title.text': newTitle});
        
        // Atualizar botões
        document.querySelectorAll('[onclick*="toggleFaturamentoView"]').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
    };

    // Função para definir períodos rápidos
    window.setPeriodo = function(dias) {
        const hoje = new Date();
        const inicio = new Date(hoje.getTime() - (dias * 24 * 60 * 60 * 1000));
        
        document.getElementById('data_inicio').value = inicio.toISOString().split('T')[0];
        document.getElementById('data_fim').value = hoje.toISOString().split('T')[0];
    };
});
</script>
{% endblock %}